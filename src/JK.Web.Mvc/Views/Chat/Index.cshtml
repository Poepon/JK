@using JK.Chat;
@{
    CurrentPageName = "Chat";
}
@section scripts
    {
<environment names="Staging,Development">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.6/dist/vue.js"></script>
    <script src="~/lib/websocket/reconnecting-websocket.js" asp-append-version="true"></script>
    <script src="~/lib/msgpack/msgpack.min.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/Chat/chatWebSocket.js"></script>
    <script src="~/view-resources/Views/Chat/Index.js" asp-append-version="true"></script>
</environment>
<environment names="Production">
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="~/lib/websocket/reconnecting-websocket.min.js" asp-append-version="true"></script>
    <script src="~/lib/msgpack/msgpack.min.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/Chat/chatWebSocket.min.js" asp-append-version="true"></script>
    <script src="~/view-resources/Views/Chat/Index.min.js" asp-append-version="true"></script>
</environment>       
}
<div class="row clearfix" id="chatApp">
    <br />
    <div class="col-xs-12 col-sm-3">
        <div class="card" style="height:85vh">
            <div class="body">
                <div id="ChatSessionAndFriendPanel" class="tabbable-line">
                    <ul class="nav nav-tabs tab-nav-right" role="tablist">
                        <li role="presentation" class="active">
                            <a href="#SessionsTab" data-toggle="tab" role="tab">
                                Sessions
                            </a>
                        </li>
                        <li role="presentation">
                            <a href="#FriendsTab" data-toggle="tab" role="tab">
                                Friends
                            </a>
                        </li>
                        <li role="presentation" class="right">
                            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#NewGroupModal">
                                NewGroup
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane active" id="SessionsTab" role="tabpanel">
                            <vue-groups-container v-bind:groups="groups" v-bind:currentgroup="currentgroup"></vue-groups-container>
                        </div>
                        <div class="tab-pane" id="FriendsTab" role="tabpanel">
                            <vue-friends-container v-bind:friends="friends"></vue-friends-container>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xs-12 col-sm-9">
        <vue-messages-container v-bind:loginuid="@AbpSession.UserId.GetValueOrDefault()" v-bind:currentgroup="currentgroup" v-bind:messages="messages" v-bind:readystate="readystate"></vue-messages-container>
    </div>
</div>

<div class="modal fade" id="NewGroupModal" tabindex="-1" role="dialog" aria-labelledby="NewGroupModalLabel" data-backdrop="static">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">
                    <span>NewGroup</span>
                </h4>
            </div>
            <div class="modal-body">
                <form role="form" novalidate class="form-validation">
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="form-group form-float">
                                <div class="form-line">
                                    <input type="text" name="GroupName" class="form-control" required maxlength="@ChatGroup.MaxNameLength">
                                    <label class="form-label">Group name</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default waves-effect" data-dismiss="modal">@L("Cancel")</button>
                        <button type="submit" class="btn btn-primary waves-effect">@L("Save")</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="x-template" id="groupsContainerTemplate">
    <div class="list-group" id="sessionsContainer">
        <a v-for="group in groups" href="#" class="list-group-item" v-bind:class="{active:group.cur}" v-on:click="changeGroup(group);">
            <div class="media">
                <div class="media-left">
                    <img :src="group.ico" class="img-circle">
                </div>
                <div class="media-body">
                    <h4 class="media-heading">{{group.gn}}</h4>
                    <span>{{group.lstmsg}}</span>
                </div>
                <div class="media-right">
                    <span class="right">{{group.lsttime | grouptime}}</span>
                    <span class="badge bg-pink">{{group.unread}}</span>
                </div>
            </div>
        </a>
    </div>
</script>

<script type="x-template" id="friendsContainerTemplate">
    <div class="list-group" id="friendsContainer">
        <a v-for="friend in friends" href="#" class="list-group-item" v-on:click="goChat">
            <img :src="friend.ico" class="img-circle">
            <span>{{friend.uname}}</span>
        </a>
    </div>
</script>

<script type="x-template" id="messagesContainerTemplate">
    <div class="card" style="height:85vh" id="messagesContainer">
        <div class="header">
            &nbsp; {{currentgroup.gname}}
            <ul class="header-dropdown m-r-10">
                <li class="dropdown">
                    <button type="button" id="btnOpen" v-on:click="online" v-if="readystate==3" class="btn btn-primary">上线</button>
                    <button type="button" v-else-if="readystate==0" class="btn btn-primary">连接中</button>
                    <button type="button" id="btnClose" v-on:click="offline" v-else class="btn btn-primary">下线</button>
                </li>
            </ul>
        </div>
        <div class="body">
            <div class="panel" style="height:65vh;overflow-y:auto;" ref="messagespanel">
                <ul class="list-group">
                    <li v-for="item in messages" class="list-group-item" >
                        <div class="media">
                            <div class="media-left">
                                <a href="#">
                                    <img src="/images/user.png" class="img-circle">
                                </a>
                            </div>
                            <div class="media-body" style="width:80%">
                                <h4 class="media-heading" v-if="item.uid!=loginuid"><span>{{item.uname}}</span></h4>
                                <span :class="{right:item.uid==loginuid}">{{item.msg}}</span>
                            </div>
                            <div class="media-right">
                                <time>{{item.time | timeago}}</time>
                                <i class="material-icons col-green">{{item.s==2?"done_all":"done"}}</i>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
            <div class="panel">
                <div class="input-group" v-if="currentgroup.gid">
                    <input type="text" v-model="message" id="message" v-on:keyup.enter="sendMessage();" name="message" class="form-control" placeholder="Write a message..." />
                    <span class="input-group-btn">
                        <input type="button" id="btnSend" v-on:click="sendMessage();" class="btn btn-primary" value="Send" />
                    </span>
                </div>
            </div>
        </div>
    </div>
</script>
