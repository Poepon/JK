(function(){$(function(){const n=new Vuex.Store({state:{readystate:3,groups:[],onlineusers:[],allmessages:[]},mutations:{changereadystate:function(n,t){n.readystate=t.readystate;console.log("changereadystate",n.readystate)},changegroups:function(n,t){n.groups=t.groups;console.log("changegroups",n.groups)},changeonlineusers:function(n,t){n.onlineusers=t.onlineusers;console.log("changeonlineusers",n.onlineusers)},changeallmessages:function(n,t){n.allmessages=n.allmessages.concat(t.messages);console.log("changeallmessages",n.allmessages)}}});Vue.filter("grouptime",function(n){return n?moment(n).format("ddd,HH:mm"):""});Vue.filter("timeago",function(n){return n?moment(n).format("HH:mm"):""});Vue.component("vue-group-item",{props:["groupinfo"],data:function(){return{unread:0,lstmsg:"",lsttime:""}},computed:{allmessages:function(){return this.$store.state.allmessages}},template:"#groupItemTemplate",methods:{getUnread:function(){},getLastMsg:function(){}}});Vue.component("vue-groups-container",{template:"#groupsContainerTemplate",computed:{groups:function(){return this.$store.state.groups},allmessages:function(){return this.$store.state.allmessages}}});Vue.component("vue-newgroup-form",{template:"#newGroupFormTemplate",data:function(){return{gname:""}},methods:{createGroup:function(){var n={gname:this.gname},t=serializeMsgPack(n);chat.sendCommand(chat.commandType.CreatePublicSession,chat.dataType.MessagePack,t);this.gname=""}}});Vue.component("vue-friends-container",{computed:{friends:function(){return this.$store.state.onlineusers}},template:"#friendsContainerTemplate",methods:{goChat:function(n){var t={tguid:n},i=serializeMsgPack(t);chat.sendCommand(chat.commandType.CreatePrivateSession,chat.dataType.MessagePack,i)}}});Vue.component("vue-allmessages-container",{template:"#allmessagesContainerTemplate",computed:{groups:function(){return this.$store.state.groups}}});Vue.component("vue-messages-container",{props:["currentgroup","loginuid"],template:"#messagesContainerTemplate",data:function(){return{message:""}},computed:{readystate:function(){return n.state.readystate},messages:function(){for(var t=[],n=0;n<this.$store.state.allmessages.length;n++)this.$store.state.allmessages[n].gid===this.currentgroup.gid&&t.push(this.$store.state.allmessages[n]);return t.sort(function(n,t){return n.mid-t.mid})}},mounted:function(){this.getMessages()},methods:{getMessages:function(){var t={gid:this.currentgroup.gid,mid:0,d:2,mc:100,loop:!1},i={gid:this.currentgroup.gid,mid:0,d:1,mc:100,loop:!0},r=serializeMsgPack(t),n;chat.sendCommand(chat.commandType.GetMessage,chat.dataType.MessagePack,r);n=serializeMsgPack(i);chat.sendCommand(chat.commandType.GetMessage,chat.dataType.MessagePack,n)},sendMessage:function(){if(this.$store.state.readystate!==1&&alert("未能连接到服务器，请检查网络后刷新重试。"),this.message.trim()!==""){var n={gid:this.currentgroup.gid,uid:1,msg:this.message},t=serializeMsgPack(n);chat.sendCommand(chat.commandType.SendMessage,chat.dataType.MessagePack,t);this.message=""}},online:function(){chat.online()},offline:function(){chat.offline()}}});var t=new Vue({el:"#chatApp",store:n,computed:{readystate:function(){return n.readystate},groups:function(){return n.groups},onlineusers:function(){return n.onlineusers},allmessages:function(){return n.allmessages}},methods:{getGroups:function(){var n=serializeMsgPack({});chat.sendCommand(chat.commandType.GetSessions,chat.dataType.MessagePack,n)},getOnlineUsers:function(){var n=serializeMsgPack({});chat.sendCommand(chat.commandType.GetOnlineUsers,chat.dataType.MessagePack,n)}}});abp.event.on("websocket.onopen",function(){n.commit("changereadystate",{readystate:1});t.getGroups()});abp.event.on("websocket.onconnecting",function(){n.commit("changereadystate",{readystate:0})});abp.event.on("websocket.onclose",function(){n.commit("changereadystate",{readystate:3})});abp.event.on("websocket.onerror",function(){console.log("onerror",event)});abp.event.on("websocket.onreceivebinary",function(t){var r=chat.receiveCommand(t),i;if(console.log("commandType",r.commandType),r.dataType===chat.dataType.MessagePack){i=deserializeMsgPack(r.data);switch(r.commandType){case chat.commandType.GetMessage:n.commit("changeallmessages",{messages:i});break;case chat.commandType.GetSessions:n.commit("changegroups",{groups:i});break;case chat.commandType.AlertMessage:alert(i.text);break;case chat.commandType.GetOnlineUsers:n.commit("changeonlineusers",{onlineusers:i})}}});abp.event.on("websocket.onreceiveblob",function(){});abp.event.on("websocket.onreceivetext",function(n){var t,i;console.log(n);t=JSON.parse(n);switch(t.CommandType){case chat.commandType.Connected:i=JSON.parse(t.Data);abp.utils.setCookieValue("chatConnectionId",i.ConnectionId)}});chat.init()})})();