(function(){$(function(){Vue.filter("grouptime",function(n){return n?moment(n).format("ddd,HH:mm"):""});Vue.filter("timeago",function(n){return n?moment(n).fromNow():""});Vue.component("vue-groups-container",{props:["groups","currentgroup"],template:"#groupsContainerTemplate",methods:{changeGroup:function(n){if(this.currentgroup.gid!==n.gid){for(var t=0;t<this.groups.length;t++)this.groups[t].cur&&(this.groups[t].cur=!1);n.cur=!0;this.$root.currentgroup=n}}}});Vue.component("vue-newgroup-form",{template:"#newGroupFormTemplate",data:function(){return{gname:""}},methods:{createGroup:function(){var n={gname:this.gname},t=serializeMsgPack(n);chat.sendCommand(chat.commandType.CreateGroup,chat.dataType.MessagePack,t);this.gname=""}}});Vue.component("vue-friends-container",{props:["friends"],template:"#friendsContainerTemplate",methods:{goChat:function(n){var t={tguid:n},i=serializeMsgPack(t);chat.sendCommand(chat.commandType.CreatePrivate,chat.dataType.MessagePack,i)}}});Vue.component("vue-messages-container",{props:["currentgroup","readystate","messages","loginuid"],template:"#messagesContainerTemplate",data:function(){return{message:""}},methods:{sendMessage:function(){if(this.readystate!==1&&alert("未能连接到服务器，请检查网络后刷新重试。"),this.message.trim()!==""){var n={gid:this.currentgroup.gid,uid:1,msg:this.message},t=serializeMsgPack(n);chat.sendCommand(chat.commandType.SendMessage,chat.dataType.MessagePack,t);this.message="";this.$refs.messagespanel.scrollBy(0,this.$refs.messagespanel.scrollHeight)}},online:function(){chat.online()},offline:function(){chat.offline()}}});var n=new Vue({el:"#chatApp",data:{currentgroup:{gname:"",gid:""},readystate:3,friends:[],messages:[],groups:[]},methods:{getGroups:function(){var n=serializeMsgPack({});chat.sendCommand(chat.commandType.GetGroups,chat.dataType.MessagePack,n)},getOnlineUsers:function(){var n=serializeMsgPack({});chat.sendCommand(chat.commandType.GetOnlineUsers,chat.dataType.MessagePack,n)}},watch:{currentgroup:function(n){var t;this.messages=[];var i={gid:n.gid,mid:0,d:2,mc:100,loop:!1},r={gid:n.gid,mid:0,d:1,mc:100,loop:!0},u=serializeMsgPack(i);chat.sendCommand(chat.commandType.GetMessage,chat.dataType.MessagePack,u);t=serializeMsgPack(r);chat.sendCommand(chat.commandType.GetMessage,chat.dataType.MessagePack,t)}}});abp.event.on("websocket.onopen",function(){n.readystate=1;n.getGroups()});abp.event.on("websocket.onconnecting",function(){n.readystate=0});abp.event.on("websocket.onclose",function(){n.readystate=3});abp.event.on("websocket.onerror",function(){console.log("onerror",event)});abp.event.on("websocket.onreceivebinary",function(t){var r=chat.receiveCommand(t),i;if(r.dataType===chat.dataType.MessagePack){i=deserializeMsgPack(r.data);switch(r.commandType){case chat.commandType.GetMessage:n.messages=n.messages.concat(i).sort(function(n,t){return n.mid-t.mid});break;case chat.commandType.GetGroups:n.groups=i;break;case chat.commandType.AlertMessage:alert(i.text);break;case chat.commandType.GetOnlineUsers:n.friends=i}}});abp.event.on("websocket.onreceiveblob",function(){});abp.event.on("websocket.onreceivetext",function(n){var t,i;console.log(n);t=JSON.parse(n);switch(t.CommandType){case chat.commandType.Connected:i=JSON.parse(t.Data);abp.utils.setCookieValue("chatConnectionId",i.ConnectionId)}});chat.init();$("#message").focus()})})();